<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Teacher Chris Flashcards</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'media',
        theme: { extend: { fontFamily: { sans: ['system-ui','-apple-system','Segoe UI','Roboto','Noto Sans','Cantarell','Ubuntu','Arial','sans-serif'] } } }
      };
    </script>

    <!-- React 18 + Babel (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* Make the bottom nav stay fixed in Review */
      .fixed-footer {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
      }
    </style>
  </head>

  <body class="bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-100">
    <div id="root" class="min-h-screen"></div>

    <script type="text/babel">
      const { useEffect, useLayoutEffect, useMemo, useRef, useState } = React;
      const uid = () => Math.random().toString(36).slice(2, 9);

      /* Utils */
      function shuffle(arr) {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }
      function loadDecks() {
        try { return JSON.parse(localStorage.getItem("decks_v2")) || []; }
        catch { return []; }
      }
      function saveDecks(decks) { localStorage.setItem("decks_v2", JSON.stringify(decks)); }
      function getLoadUrlFromHash() {
        const m = location.hash.match(/^#\/load\?url=(.+)$/);
        return m ? decodeURIComponent(m[1]) : null;
      }
      async function loadDeckFromUrl(jsonUrl) {
        const res = await fetch(jsonUrl, { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to fetch: " + res.status);
        const data = await res.json();
        return {
          id: uid(),
          name: data.name ?? "Shared Deck",
          cards: (data.cards ?? []).map(c => ({
            id: uid(),
            image: c.image || "",
            audio: c.audio || "",
            text:  c.text  || ""
          }))
        };
      }
      function exportDeckJSON(deck) {
        const json = JSON.stringify({ name: deck.name, cards: deck.cards }, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = (deck.name || "deck") + ".json";
        a.click();
        URL.revokeObjectURL(a.href);
      }
      function buildShareLinkFromJsonUrl(publicJsonUrl) {
        const base = location.origin + location.pathname; // works on GitHub Pages too
        return base + "#/load?url=" + encodeURIComponent(publicJsonUrl.trim());
      }

      /* App */
      function App() {
        const [decks, setDecks] = useState(() => loadDecks());
        const [view, setView] = useState({ kind: "home" });

        useEffect(() => saveDecks(decks), [decks]);

        // Handle direct share links #/load?url=...
        useLayoutEffect(() => {
          const jsonUrl = getLoadUrlFromHash();
          if (!jsonUrl) return;
          (async () => {
            try {
              const deck = await loadDeckFromUrl(jsonUrl);
              setDecks(prev => [deck, ...prev]);
              history.replaceState(null, "", location.pathname + "#/review/" + deck.id);
              setView({ kind: "review", deckId: deck.id });
            } catch (e) {
              alert("Could not load shared deck.");
              location.hash = "";
              setView({ kind: "home" });
            }
          })();
        }, []);

        // Hash router
        useEffect(() => {
          const apply = () => {
            const h = location.hash;
            const mR = h.match(/^#\/review\/([a-z0-9]+)/i);
            const mE = h.match(/^#\/edit\/([a-z0-9]+)/i);
            if (mR) setView({ kind: "review", deckId: mR[1] });
            else if (mE) setView({ kind: "edit", deckId: mE[1] });
            else if (!getLoadUrlFromHash()) setView({ kind: "home" });
          };
          apply();
          window.addEventListener("hashchange", apply);
          return () => window.removeEventListener("hashchange", apply);
        }, []);

        if (view.kind === "home") {
          return <Home decks={decks} setDecks={setDecks}
            goEdit={id => location.hash = "#/edit/" + id}
            goReview={id => location.hash = "#/review/" + id} />;
        }
        const deck = decks.find(d => d.id === view.deckId);
        if (!deck) { location.hash = ""; return null; }
        if (view.kind === "edit") {
          return <EditDeck deck={deck}
            updateDeck={(next) => setDecks(all => all.map(d => d.id === deck.id ? next : d))}
            goHome={() => location.hash = ""}
            goReview={() => location.hash = "#/review/" + deck.id} />;
        }
        return <Review deck={deck} goBack={() => location.hash = ""} />;
      }

      function Home({ decks, setDecks, goEdit, goReview }) {
        const [newName, setNewName] = useState("");
        const create = () => {
          const n = newName.trim();
          if (!n) return;
          const d = { id: uid(), name: n, cards: [] };
          setDecks(a => [d, ...a]);
          setNewName("");
          location.hash = "#/edit/" + d.id;
        };
        const del = (id) => setDecks(a => a.filter(d => d.id !== id));

        return (
          <div className="min-h-screen flex items-center justify-center p-6">
            <div className="w-full max-w-2xl rounded-2xl shadow-xl p-6 bg-white/95 dark:bg-slate-800">
              <h1 className="text-3xl font-bold mb-4">Teacher Chris Flashcards</h1>
              <div className="flex gap-2 mb-6">
                <input className="flex-1 px-3 py-2 border rounded-md"
                       placeholder="New deck name"
                       value={newName} onChange={e=>setNewName(e.target.value)} />
                <button onClick={create} className="px-3 py-2 border rounded-md bg-indigo-600 text-white">
                  Create
                </button>
              </div>
              <div className="flex flex-col gap-2">
                {decks.map(d => (
                  <div key={d.id} className="flex items-center justify-between border rounded-lg px-3 py-2 bg-white dark:bg-slate-700">
                    <div>
                      <div className="font-semibold">{d.name}</div>
                      <div className="text-xs opacity-80">{d.cards.length} cards</div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={()=>goEdit(d.id)} className="px-2 py-1 border rounded-md">Edit</button>
                      <button onClick={()=>goReview(d.id)} className="px-2 py-1 border rounded-md">Review</button>
                      <button onClick={()=>del(d.id)} className="px-2 py-1 border rounded-md">Delete</button>
                    </div>
                  </div>
                ))}
              </div>
              <div className="mt-6 text-sm opacity-70">
                Tip: On GitHub Pages, share links look like <code>...#/load?url=PUBLIC_JSON_URL</code>.
              </div>
            </div>
          </div>
        );
      }

      function DeckShareBox({ deck }) {
        const makeShareFromUrl = () => {
          const u = prompt("Paste PUBLIC JSON URL (e.g., Gist RAW URL):");
          if (!u) return;
          const link = buildShareLinkFromJsonUrl(u);
          navigator.clipboard.writeText(link).finally(() => alert("Copied link:\\n" + link));
        };
        const openFromUrl = () => {
          const u = prompt("Paste PUBLIC JSON URL:");
          if (u) location.hash = "#/load?url=" + encodeURIComponent(u);
        };
        return (
          <div className="mt-6 grid gap-3 sm:grid-cols-3">
            <button onClick={()=>exportDeckJSON(deck)} className="px-3 py-2 border rounded-md">‚¨áÔ∏è Export JSON</button>
            <button onClick={makeShareFromUrl} className="px-3 py-2 border rounded-md">üîó Make share link</button>
            <button onClick={openFromUrl} className="px-3 py-2 border rounded-md">üîç Open from URL</button>
          </div>
        );
      }

      function EditDeck({ deck, updateDeck, goHome, goReview }) {
        const [image, setImage] = useState("");
        const [audio, setAudio] = useState("");
        const [text, setText]   = useState("");

        const add = () => {
          const t = text.trim();
          if (!t) return;
          updateDeck({
            ...deck,
            cards: [{ id: uid(), image: image.trim(), audio: audio.trim(), text: t }, ...deck.cards]
          });
          setImage(""); setAudio(""); setText("");
        };
        const remove = (id) => updateDeck({ ...deck, cards: deck.cards.filter(c => c.id !== id) });

        return (
          <div className="min-h-screen flex items-center justify-center p-6">
            <div className="w-full max-w-3xl rounded-2xl shadow-xl p-6 bg-white/95 dark:bg-slate-800">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold">{deck.name}</h2>
                <div className="flex gap-2">
                  <button onClick={goHome} className="px-2 py-1 border rounded-md">Home</button>
                  <button onClick={goReview} className="px-2 py-1 border rounded-md">Review</button>
                </div>
              </div>

              <div className="grid sm:grid-cols-3 gap-2 mb-3">
                <input value={image} onChange={e=>setImage(e.target.value)} placeholder="Image URL"
                       className="border px-3 py-2 rounded-md" />
                <input value={audio} onChange={e=>setAudio(e.target.value)} placeholder="Audio URL (.mp3/.wav)"
                       className="border px-3 py-2 rounded-md" />
                <input value={text} onChange={e=>setText(e.target.value)} placeholder="Term / caption"
                       className="border px-3 py-2 rounded-md" />
              </div>
              <button onClick={add} className="mb-6 px-3 py-2 border rounded-md bg-indigo-600 text-white">
                Add Card
              </button>

              <div className="grid gap-3">
                {deck.cards.map(c => (
                  <div key={c.id} className="flex items-center justify-between border rounded-lg px-3 py-2 bg-white dark:bg-slate-700">
                    <div className="flex items-center gap-3">
                      {c.image
                        ? <img src={c.image} className="w-16 h-16 object-cover rounded-lg" />
                        : <div className="w-16 h-16 border-dashed border grid place-items-center text-xs opacity-60">no image</div>}
                      <div>
                        <div className="font-medium">{c.text || <span className="opacity-60">(no text)</span>}</div>
                        {c.audio && <div className="text-xs opacity-80">üîà {c.audio}</div>}
                      </div>
                    </div>
                    <button onClick={()=>remove(c.id)} className="px-2 py-1 border rounded-md">Remove</button>
                  </div>
                ))}
              </div>

              {/* Share tools visible ONLY in Edit screen */}
              <DeckShareBox deck={deck} />
            </div>
          </div>
        );
      }

      function Review({ deck, goBack }) {
        const [order, setOrder] = useState(deck.cards.map(c => c.id));
        const [i, setI] = useState(0);
        const [show, setShow] = useState(false);
        const cardsById = useMemo(() => {
          const m = new Map();
          deck.cards.forEach(c => m.set(c.id, c));
          return m;
        }, [deck.cards]);
        useEffect(() => {
          setOrder(deck.cards.map(c => c.id));
          setI(0);
          setShow(false);
        }, [deck.id]);

        const current = cardsById.get(order[i]);
        const next = () => { setShow(false); setI(x => (x + 1) % order.length); };
        const prev = () => { setShow(false); setI(x => (x - 1 + order.length) % order.length); };
        const reshuffle = () => { setOrder(shuffle(order)); setI(0); setShow(false); };

        const audioRef = useRef(null);
        useEffect(() => {
          if (show && current?.audio && audioRef.current) {
            audioRef.current.currentTime = 0;
            audioRef.current.play().catch(()=>{});
          }
        }, [show, current?.audio]);

        if (!current) {
          return (
            <div className="min-h-screen flex items-center justify-center p-6">
              <div className="w-full max-w-md rounded-2xl shadow-xl p-6 bg-white/95 dark:bg-slate-800 text-center">
                <div className="mb-4">No cards in this deck.</div>
                <button onClick={goBack} className="px-3 py-2 border rounded-md">Back</button>
              </div>
            </div>
          );
        }

        return (
          <div className="min-h-screen flex flex-col p-6">
            <div className="w-full max-w-3xl mx-auto rounded-2xl shadow-xl p-6 bg-white/95 dark:bg-slate-800 flex-1 flex flex-col">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-2xl font-bold">{deck.name}</h2>
                <button onClick={goBack} className="px-2 py-1 border rounded-md">Back</button>
              </div>

              <div className="flex-1 flex flex-col justify-center mb-4 select-none" onClick={() => setShow(true)}>
                {current.image
                  ? <img src={current.image} className="max-h-[50vh] object-contain mx-auto rounded-lg" />
                  : <div className="h-[40vh] grid place-items-center text-slate-400">(no image)</div>}
              </div>

              <div className="text-center mb-4">
                {!show
                  ? <button onClick={()=>setShow(true)} className="px-4 py-3 border rounded-lg">Show Answer</button>
                  : <div className="text-2xl font-semibold">{current.text}</div>}
                {show && current.audio && (
                  <div className="mt-2">
                    <audio ref={audioRef} src={current.audio} />
                    <button onClick={()=>audioRef.current?.play()} className="px-3 py-2 border rounded-md">üîà Play audio</button>
                  </div>
                )}
              </div>
            </div>

            {/* Fixed, large, phone-friendly nav row */}
            <div className="fixed-footer w-full max-w-3xl mx-auto mt-4">
              <div className="flex gap-2">
                <button onClick={prev} className="flex-1 py-4 text-lg border rounded-xl bg-slate-200 dark:bg-slate-700">‚Äπ Previous</button>
                <button onClick={reshuffle} className="flex-1 py-4 text-lg border rounded-xl bg-slate-200 dark:bg-slate-700">‚ü≤ Shuffle</button>
                <button onClick={next} className="flex-1 py-4 text-lg border rounded-xl bg-slate-200 dark:bg-slate-700">Next ‚Ä∫</button>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App/>);
    </script>
  </body>
</html>
